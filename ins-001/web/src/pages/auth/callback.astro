---
/**
 * Auth Callback Page
 *
 * Handles magic link redirects from Supabase.
 * Processes the #access_token in the URL hash and establishes the session.
 */
export const prerender = false;

import '../../styles/global.css';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Signing in... | Phronos Instruments</title>
  </head>
  <body>
    <div class="callback-container">
      <div class="callback-content">
        <div class="spinner"></div>
        <p class="status" id="status">Verifying your identity...</p>
      </div>
    </div>

    <script>
      import { supabase } from '../../lib/supabase';
      import { api } from '../../lib/api';

      const statusEl = document.getElementById('status');

      function showStatus(message: string, isError = false) {
        if (statusEl) {
          statusEl.textContent = message;
          if (isError) {
            statusEl.style.color = 'var(--alert)';
          }
        }
      }

      // Transfer games from anonymous session to authenticated user
      async function transferPendingGames(): Promise<number> {
        const pendingTransferId = localStorage.getItem('pendingGameTransfer');
        if (!pendingTransferId) return 0;

        try {
          const result = await api.users.transferGames(pendingTransferId);
          console.log('Game transfer result:', result);
          return result.transferred_count;
        } catch (err) {
          console.error('Failed to transfer games:', err);
          return 0;
        } finally {
          // Always clear the pending transfer ID
          localStorage.removeItem('pendingGameTransfer');
        }
      }

      async function handleCallback() {
        try {

          // Get the return path from query params (set when magic link was requested)
          const searchParams = new URLSearchParams(window.location.search);
          const returnTo = searchParams.get('returnTo') || '/';

          // Check if we have a hash fragment with access_token or error
          const hash = window.location.hash;
          const params = new URLSearchParams(hash.substring(1));

          // Check for error in the hash (e.g., expired link)
          const errorCode = params.get('error');
          const errorDescription = params.get('error_description');

          if (errorCode) {
            const message = errorDescription
              ? decodeURIComponent(errorDescription.replace(/\+/g, ' '))
              : 'Authentication failed';
            showStatus(message, true);

            setTimeout(() => {
              window.location.href = returnTo;
            }, 3000);
            return;
          }

          if (hash && hash.includes('access_token')) {
            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');

            if (accessToken && refreshToken) {
              // Set the session manually
              const { data, error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
              });

              if (error) {
                throw error;
              }

              if (data.session) {
                // Clear the hash from URL for cleaner look
                window.history.replaceState(null, '', window.location.pathname);

                // Check if we need to transfer games from an anonymous session
                showStatus('Signed in successfully! Checking for games to transfer...');
                const transferred = await transferPendingGames();

                if (transferred > 0) {
                  showStatus(`Transferred ${transferred} game(s) to your account. Redirecting...`);
                } else {
                  showStatus('Signed in successfully! Redirecting...');
                }

                setTimeout(() => {
                  window.location.href = returnTo;
                }, 1500);
                return;
              }
            }
          }

          // Fallback: check if there's already a session
          const { data: { session }, error } = await supabase.auth.getSession();

          if (error) {
            throw error;
          }

          if (session) {
            // Check if we need to transfer games from an anonymous session
            showStatus('Signed in successfully! Checking for games to transfer...');
            const transferred = await transferPendingGames();

            if (transferred > 0) {
              showStatus(`Transferred ${transferred} game(s) to your account. Redirecting...`);
            } else {
              showStatus('Signed in successfully! Redirecting...');
            }

            setTimeout(() => {
              window.location.href = returnTo;
            }, 1500);
          } else {
            // No session found - might be expired or invalid link
            showStatus('Link expired or invalid. Redirecting...', true);

            setTimeout(() => {
              window.location.href = returnTo;
            }, 2000);
          }
        } catch (err) {
          console.error('Auth callback error:', err);
          const errorMessage = err instanceof Error ? err.message : 'Unknown error';
          showStatus(`Error: ${errorMessage}`, true);

          // returnTo might not be defined if error happened early
          setTimeout(() => {
            window.location.href = '/';
          }, 3000);
        }
      }

      handleCallback().catch((err) => {
        console.error('Unhandled auth callback error:', err);
        const statusEl = document.getElementById('status');
        if (statusEl) {
          statusEl.textContent = 'Authentication error. Redirecting...';
          statusEl.style.color = 'var(--alert)';
        }
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      });
    </script>

    <style>
      body {
        min-height: 100vh;
        background: var(--bg-deep);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image:
          linear-gradient(var(--grid-color) 1px, transparent 1px),
          linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
        background-size: var(--grid-size) var(--grid-size);
        pointer-events: none;
        z-index: 0;
      }

      .callback-container {
        position: relative;
        z-index: 1;
        text-align: center;
      }

      .callback-content {
        background: var(--bg);
        border: 1px solid var(--faded-light);
        padding: 3rem;
        max-width: 400px;
      }

      .spinner {
        width: 32px;
        height: 32px;
        border: 2px solid var(--faded-light);
        border-top-color: var(--gold);
        border-radius: 50%;
        margin: 0 auto 1.5rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .status {
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--faded);
        margin: 0;
      }
    </style>
  </body>
</html>
