---
name: ins-001-security
description: Security rules for API route handlers - service key prohibition, LLM prompt safety
---

# Overview

## üö® ABSOLUTE RULE: Never Use Service Key in Routes

```python
# ‚ùå FORBIDDEN - Bypasses all RLS, causes data breach
from app.config import SUPABASE_SERVICE_KEY
supabase = create_client(SUPABASE_URL, SUPABASE_SERVICE_KEY)

# ‚úÖ REQUIRED - Uses user JWT, RLS enforced
supabase, user = await get_authenticated_client(credentials)
```

The service key is ONLY for background jobs (profile computation, cleanup).
NEVER import or use it in route handlers.

## Word Validation: ALL WORDS ARE OPEN

Seeds, clues, AND guesses can be ANY word. No vocabulary validation.

```python
# ‚úÖ CORRECT - Accept any word
seed_word = request.seed_word.lower().strip()
clues_clean = [c.lower().strip() for c in request.clues]
guesses_clean = [g.lower().strip() for g in request.guesses]

# ‚ùå WRONG - Don't validate against vocabulary
if not await validate_word(supabase, word):
    raise HTTPException(400, "Invalid")  # DON'T DO THIS
```

Why this is safe:
- LLM prompt safety comes from XML structure, not vocabulary filtering
- OpenAI embeds ANY string via subword tokenization
- Gibberish inputs hurt only that player's score (self-correcting)

## LLM Prompt Safety: XML Escaping

This is the security layer for LLM inputs:

```python
# ‚úÖ REQUIRED - Always XML-escape user content
escaped_clues = [html.escape(c) for c in clues]
clue_xml = "\n".join(f"  <clue>{c}</clue>" for c in escaped_clues)

prompt = f"""
<clues>
{clue_xml}
</clues>
"""
```

## Error Response Format

```python
# ‚úÖ CORRECT - Dict detail with ErrorResponse shape
raise HTTPException(
    status_code=400,
    detail={"error": "Invalid request", "detail": "Details here"}
)

# ‚ùå WRONG - String detail
raise HTTPException(400, "Invalid")
```

## Contextual Embeddings for Scoring

```python
# ‚úÖ CORRECT - Include clues as context for disambiguation
seed_emb = await get_contextual_embedding(seed_word, clues)
guess_embs = [await get_contextual_embedding(g, clues) for g in guesses]

# ‚ùå WRONG for convergence scoring - No context
seed_emb = await get_embedding(seed_word)
```

## Async Consistency

```python
# ‚úÖ CORRECT
async def create_game(...):
    result = await get_embedding(word)

# ‚ùå WRONG
def create_game(...):  # Should be async
    result = get_embedding(word)  # Missing await
```

## Analytics Tracking (Optional)

Track vocabulary membership for research, but don't block:

```python
# Track for analytics, don't block submission
seed_in_vocabulary = await check_word_in_vocabulary(supabase, seed_word)
```